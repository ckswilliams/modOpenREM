{% extends "remapp/base.html" %}

{% block navrf %}<li class="active">{% endblock %}

{% block mainblock %}
    <div class="row">
        <div class="col-md-5">
            <h1>Detail list of events</h1>

            <ul>
                <li>
                    Accession number:
                    {% if not generalstudymoduleattr.accession_hashed %}
                        {{ generalstudymoduleattr.accession_number }}
                    {% else %}
                        <i>hidden</i>
                    {% endif %}
                </li>
                <li>Study date: {{ generalstudymoduleattr.study_date }}</li>
                <li>Study time: {{ generalstudymoduleattr.study_time|date:"H:i" }}</li>
                <li>Study description: {{ generalstudymoduleattr.study_description }}</li>
                <li>Requested procedure: {{ generalstudymoduleattr.requested_procedure_code_meaning }}</li>
                <li>Patient age: {{ generalstudymoduleattr.patientstudymoduleattr_set.get.patient_age_decimal|floatformat:1 }}</li>
                <li>Patient weight: {{ generalstudymoduleattr.patientstudymoduleattr_set.get.patient_weight|floatformat:1 }} kg</li>
                <li>
                    {% for record in generalstudymoduleattr.projectionxrayradiationdose_set.get.accumxraydose_set.all %}
                        Total DAP, {{ record.acquisition_plane }}:
                        {{ record.accumintegratedprojradiogdose_set.get.convert_gym2_to_cgycm2|floatformat:1 }} cGy.cm<sup>2</sup>
                        <br>
                    {% endfor %}
                </li>
                <li>
                    {% for record in generalstudymoduleattr.projectionxrayradiationdose_set.get.accumxraydose_set.all %}
                        Total dose at RP, {{ record.acquisition_plane }}:
                        {{ record.accumintegratedprojradiogdose_set.get.dose_rp_total|floatformat:6 }} Gy
                        <br>
                    {% endfor %}
                </li>
                <li>Hospital: {{ generalstudymoduleattr.generalequipmentmoduleattr_set.get.institution_name }}</li>
                <li>
                    Scanner:
                    {{ generalstudymoduleattr.generalequipmentmoduleattr_set.get.manufacturer }} |
                    {{ generalstudymoduleattr.generalequipmentmoduleattr_set.get.manufacturer_model_name }} |
                    {{ generalstudymoduleattr.generalequipmentmoduleattr_set.get.station_name }}
                </li>
                <li>Study UID: {{ generalstudymoduleattr.study_instance_uid }}</li>
                <li>Test patient indicators? {{ generalstudymoduleattr.patientmoduleattr_set.get.not_patient_indicator }}</li>
            </ul>
        </div>
        <div class="col-md-7">
            <div class="ajax-progress"><img src="{{ STATIC_URL }}img/ajax-loader.gif"></div>

            <h2>OpenSkin radiation exposure incidence map</h2>


            <script src="{{ STATIC_URL }}js/chroma.min.js"></script>

            <div class="skinDoseMap">
                <canvas id="skinDoseMap" width="360" height="280"></canvas>
            </div>

            <div class="colourScale">
                <canvas id="colourScale" width="50" height="280"></canvas>
            </div>

            <div class="colour_scale_selection" id="colour_scale_selection">
                <form id="colour_scale_form" onsubmit="updateColourScale(this); return false;">
                    <table>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="OrRd"></td>
                            <td><canvas id="OrRd"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="PuBu"></td>
                            <td><canvas id="PuBu"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="BuPu"></td>
                            <td><canvas id="BuPu"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="Oranges"></td>
                            <td><canvas id="Oranges"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="BuGn"></td>
                            <td><canvas id="BuGn"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="YlOrBr"></td>
                            <td><canvas id="YlOrBr"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="YlGn"></td>
                            <td><canvas id="YlGn"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="Reds"></td>
                            <td><canvas id="Reds"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="RdPu"></td>
                            <td><canvas id="RdPu"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="Greens"></td>
                            <td><canvas id="Greens"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="YlGnBu"></td>
                            <td><canvas id="YlGnBu"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="Purples"></td>
                            <td><canvas id="Purples"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="GnBu"></td>
                            <td><canvas id="GnBu"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="Greys"></td>
                            <td><canvas id="Greys"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="YlOrRd"></td>
                            <td><canvas id="YlOrRd"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="PuRd"></td>
                            <td><canvas id="PuRd"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="Blues"></td>
                            <td><canvas id="Blues"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="PuBuGn"></td>
                            <td><canvas id="PuBuGn"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="Spectral"></td>
                            <td><canvas id="Spectral"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="RdYlGn"></td>
                            <td><canvas id="RdYlGn"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="RdBu"></td>
                            <td><canvas id="RdBu"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="PiYG"></td>
                            <td><canvas id="PiYG"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="PRGn"></td>
                            <td><canvas id="PRGn"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="RdYlBu"></td>
                            <td><canvas id="RdYlBu"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="BrBG"></td>
                            <td><canvas id="BrBG"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="RdGy"></td>
                            <td><canvas id="RdGy"></canvas></td>
                        </tr>
                        <tr>
                            <td><input type="radio" name="colour_choice" value="PuOr"></td>
                            <td><canvas id="PuOr"></canvas></td>
                        </tr>
                        <tr>
                            <td colspan="2"><a onclick="$('.colour_scale_selection').hide();" class="btn btn-default btn-sm" role="button">Hide colour scales</a></td>
                        </tr>
                    </table>
                </form>
                <script>
                    $('#colour_scale_form input[type=radio]').change(function() {
                        useNewColourScale(this.value);
                    });
                </script>
            </div>

            <div class="noFloat">
                <table>
                    <tr>
                        <td>Max dose in whole map:</td>
                        <td id="maxDose">0.000 Gy</td>
                    </tr>
                    <tr>
                        <td>Dose at mouse pointer:</td>
                        <td id="hoverDose">0.000 Gy</td>
                    </tr>
                </table>
            </div>

            <div id="skin_map_wwwl_controls">
                <table>
                    <tr>
                        <td>Window level:</td>
                        <td><input type="range" name="windowLevelSlider" id="windowLevelSlider" min="0" max="2" value="0.1" step="0.001" oninput="updateWindowLevel(this.value)"/></td>
                        <td><input type="text" name="currentWindowLevel" id="currentWindowLevel" size="5" onchange="updateWindowLevel(this.value)"/> Gy</td>
                    </tr>
                    <tr>
                        <td>Window width:</td>
                        <td><input type="range" name="windowWidthSlider" id="windowWidthSlider" min="0" max="4" value="0.2" step="0.001" oninput="updateWindowWidth(this.value)"/></td>
                        <td><input type="text" name="currentWindowWidth" id="currentWindowWidth" size="5" onchange="updateWindowWidth(this.value)"/> Gy</td>
                    </tr>
                </table>
                <input type="button" onclick="reset()" value="Reset controls" class="btn btn-default btn-sm" role="button" />
                <a onclick="$('#skin_map_maxmin_controls').show();$('#skin_map_wwwl_controls').hide();" class="btn btn-default btn-sm" role="button">Swap to max/min controls</a>
                <a onclick="$('.colour_scale_selection').show();" class="btn btn-default btn-sm" role="button">Change colour scale</a>
            </div>

            <div id="skin_map_maxmin_controls">
                <table>
                    <tr>
                        <td>Minimum displayed dose:</td>
                        <td><input type="range" name="minDoseSlider" id="minDoseSlider" min="0" max="2" value="0.1" step="0.001" oninput="updateMinDisplayedDose(this.value)"/></td>
                        <td><input type="text" name="currentMinDisplayedDose" id="currentMinDisplayedDose" size="5" onchange="updateMinDisplayedDose(this.value)"/> Gy</td>
                    </tr>
                    <tr>
                        <td>Maximum displayed dose:</td>
                        <td><input type="range" name="maxDoseSlider" id="maxDoseSlider" min="0" max="4" value="0.2" step="0.001" oninput="updateMaxDisplayedDose(this.value)"/></td>
                        <td><input type="text" name="currentMaxDisplayedDose" id="currentMaxDisplayedDose" size="5" onchange="updateMaxDisplayedDose(this.value)"/> Gy</td>
                    </tr>
                </table>
                <input type="button" onclick="reset()" value="Reset controls" class="btn btn-default btn-sm" role="button" />
                <a onclick="$('#skin_map_maxmin_controls').hide();$('#skin_map_wwwl_controls').show();" class="btn btn-default btn-sm" role="button">Swap to WW/WL controls</a>
                <a onclick="$('.colour_scale_selection').show();" class="btn btn-default btn-sm" role="button">Change colour scale</a>
            </div>

            <script src="{{ STATIC_URL }}js/rfSkinDoseMapping.js"></script>

            <script>
                $('#skin_map_maxmin_controls').show();
                $('#skin_map_wwwl_controls').hide();
            </script>

            <script src="{{ STATIC_URL }}js/rfSkinDoseMappingAjax.js"></script>

        </div>
  </div>

<table class="table table-striped table-bordered">
    <th>Time</th><th>Acquisition protocol</th><th>Plane</th><th>DAP (cGy.cm<sup>2</sup>)</th><th>Exposure time</th><th>kVp</th><th>mA</th><th>Filters</th><th>Angle</th><th>II Diameter</th>
    {% for event in generalstudymoduleattr.projectionxrayradiationdose_set.get.irradeventxraydata_set.all %}
    <tr>
        <td>{{ event.date_time_started|time:"H:i.s" }}</td>
        <td>{{ event.acquisition_protocol }}</td>
        <td>{{ event.acquisition_plane }}</td>
        <td>{{ event.convert_gym2_to_cgycm2|floatformat:3 }}</td>
        <td>{{ event.irradeventxraysourcedata_set.get.exposure_time|floatformat:1 }}</td>
        <td>{{ event.irradeventxraysourcedata_set.get.kvp_set.get.kvp|floatformat:0 }}</td>
        <td>{{ event.irradeventxraysourcedata_set.get.xraytubecurrent_set.get.xray_tube_current|floatformat:1 }}</td>
        <td>
            {% for xrayfilt in event.irradeventxraysourcedata_set.get.xrayfilters_set.all %}
                {% if xrayfilt.xray_filter_material.code_value == 'C-120F9' %}
                    Al: {{ xrayfilt.xray_filter_thickness_minimum|floatformat:2 }} - {{ xrayfilt.xray_filter_thickness_maximum|floatformat:2 }} <br>
                {% elif xrayfilt.xray_filter_material.code_value == 'C-127F9' %}
                    Cu: {{ xrayfilt.xray_filter_thickness_minimum|floatformat:2 }} - {{ xrayfilt.xray_filter_thickness_maximum|floatformat:2 }} <br>
                {% else %}
                    {{ xrayfilt.xray_filter_material.code_meaning }}: {{ xrayfilt.xray_filter_thickness_minimum|floatformat:2 }} - {{ xrayfilt.xray_filter_thickness_maximum|floatformat:2 }} <br>
                {% endif %}
            {% endfor %}
        </td>
        <td>{{ event.irradeventxraymechanicaldata_set.get.positioner_primary_angle|floatformat:1 }}</td>
        <td>{{ event.irradeventxraysourcedata_set.get.ii_field_size }}</td>
    </tr>
    {% endfor %}
</table>

{% if is_paginated %}
<p class="pagination">
    {% if has_next %}
    <a class="older" href="?page={{ next }}" title="View older posts">Older</a>
    {% endif %}
    {% if has_next and has_previous %} | {% endif %}
    {% if has_previous %}
    <a class="newer" href="?page={{ previous }}" title="View newer posts">Newer</a>
    {% endif %}
</p>
{% endif %}

{% endblock %}	
