{% extends "remapp/filteredbase.html" %}

{% block navbar %}
            <li class="active"><a href="/openrem/ct">CT</a></li>
            <li><a href="/openrem/rf">Fluoroscopy</a></li>
            <li><a href="/openrem/mg">Mammography</a></li>
            <li><a href="/openrem/dx">Radiography</a></li>
{% endblock %}

{% block toprow %}
      {% load pagination_tags %}    
    
      <p>
        There are {{ filter.count }} studies in this list.
      </p>
        {% if admin.exportperm or admin.adminperm %}
        <ul>
          <li><strong>Note:</strong> Apply the filter first to refine what is exported.</li>
          <li><a href="/openrem/exportctcsv1/?{{ request.GET.urlencode }}">Export to CSV</a> </li>
          <li><a href="/openrem/exportctxlsx1/?{{ request.GET.urlencode }}">Export to XLSX</a></li>
        </ul>

        {% else %}
        <p>
          Sorry, you don't have enough permissions to enable study export.
        </p>
        {% endif %}
        
{% endblock %}


{% block col2 %}


    {{ studyfilter }}






          <div class="panel panel-info">
            <div class="panel-heading">
              <h3 class="panel-title">Exam filter</h3>
            </div>
            <div class="panel-body">
                <i>Date format yyyy-mm-dd</i>
                <form action="" method="get" class="form-horizontal" role="form">
                        {% for field in filter.form %}
                            <div class="form-group">
                                <div class="col-xs-4">
                                    <label>{{ field.label_tag }}</label>
                                </div>
                                <div class="col-xs-8">
                                  {{ field.errors }}
                                  {{ field }}
                                </div>
                            </div>
                        {% endfor %}
                    </table>
                    <input type="submit" />
                </form> 
            </div>
          </div>


<script>
$('.datepicker').datepicker({
    format: "yyyy-mm-dd",
    autoclose: true,
    todayHighlight: true
    });
</script>

{% endblock %}

{% block col1 %}


      {% autopaginate filter.qs 25 as filter_list %}
      {% paginate %}
    <table class="table table-striped">
        <th>Institution</th><th>Make | Model | Station name</th><th>Date</th><th>Study description | Accession number</th><th>Number of events</th><th>Dose Length Product Total mGy.cm</th>
        {% if admin.adminperm %}
        <th>Delete?</th>
        {% endif %}
        {% for exam in filter_list %}
        <tr>
            <td>{{ exam.general_equipment_module_attributes_set.get.institution_name }}</td>
            <td>
                {{ exam.general_equipment_module_attributes_set.get.manufacturer }} |
                {{ exam.general_equipment_module_attributes_set.get.manufacturer_model_name }} |
                {{ exam.general_equipment_module_attributes_set.get.station_name }}        
            </td>
            <td>{{ exam.study_date|date:"Y-m-d" }} {{ exam.study_time|date:"H:i" }}</td>
            <td>
                <a href="/openrem/ct/{{ exam.id }}/">{{ exam.study_description }}</a> |
                {{ exam.accession_number }} |
                {{ exam.patient_study_module_attributes_set.get.patient_size|floatformat:0 }} cm |
                {{ exam.patient_study_module_attributes_set.get.patient_weight|floatformat:0 }} kg
            </td>
            <td>{{ exam.ct_radiation_dose_set.get.ct_accumulated_dose_data_set.get.total_number_of_irradiation_events }}</td>
            <td>{{ exam.ct_radiation_dose_set.get.ct_accumulated_dose_data_set.get.ct_dose_length_product_total|floatformat:2 }}</td>
            {% if admin.adminperm %}
            <td>
              <a href="{% url 'study_delete' exam.id %}">Delete</a>
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </table>

    {% paginate %}

{% endblock %}

{% block jsblock %}
{% endblock %}

        {% block plotdata %}
<script src="{{ STATIC_URL }}js/highcharts.js"></script>
<script src="{{ STATIC_URL }}js/exporting.js"></script>




{% if acquisitionSummary %}
<script src="{{ STATIC_URL }}js/drilldown.js"></script>

<!-- Plot of mean DLP per acquisition protocol, with drilldown to histogram of DLP values for each protocol. -->
<div class="panel-group" id="accordion">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
          Plot mean DLP for each acquisition protocol in currently filtered data. Click this text to toggle between hidden and visible.
        </a>
      </h4>
    </div>
    <div id="collapseTwo" class="panel-collapse collapse">
      <div class="panel-body">
         <div id="histogramPlotDIV" style="width: 95%; height: 600px; margin: 0 0"></div>
         <p>Click on an individual column to show a histogram of data for that acquisition protocol.</p>
      </div>
    </div>
  </div>
</div>

<script>
var protocolNames     = [
                        {% for name in acquisitionSummary %}
                            "{{name.ct_radiation_dose__ct_irradiation_event_data__acquisition_protocol}}"
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var protocolCounts    = [
                        {% for protocol in acquisitionHistogramData %}
                            [
                            {% for dataCounts in protocol.0 %}
                                {{dataCounts}}
                                {% if not forloop.last %},{% endif %}
                            {% endfor %}
                            ]
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var protocolBins      = [
                        {% for protocolEdges in acquisitionHistogramData %}
                            [
                            {% for edges in protocolEdges.1 %}
                                {{edges}}
                                {% if not forloop.last %},{% endif %}
                            {% endfor %}
                            ]
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var seriesData        = [
                        {% for testData in acquisitionSummary %}
                            {{'{'}}name:protocolNames[{{forloop.counter}}-1],y: {{testData.mean_dlp}},drilldown:protocolNames[{{forloop.counter}}-1]{{'}'}}
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var seriesDataN       = [
                        {% for testData in acquisitionSummary %}
                            '{{testData.num_acq}}'
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var seriesDrilldown   = [
                        {% for protocolCountsArray in acquisitionHistogramData %}
                            {id: protocolNames[{{forloop.counter}}-1],name: protocolNames[{{forloop.counter}}-1],useHTML: true,data: [
                            {% for dataCounts in protocolCountsArray.0 %}
                                [protocolBins[{{forloop.parentloop.counter}}-1][{{forloop.counter}}-1].toFixed(1).toString() + ' to < ' + protocolBins[{{forloop.parentloop.counter}}-1][{{forloop.counter}}].toFixed(1).toString(),{{dataCounts}}]
                                {% if not forloop.last %},{% endif %}
                            {% endfor %}]}
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
</script>

<script type="text/javascript">
$(function () {

var drilldownTitle = 'Histogram of ';
var defaultTitle   = 'Mean DLP per acquisition protocol';
var tooltipData = [2];

var chart = new Highcharts.Chart({
        chart: {
            type: 'column',
            renderTo: 'histogramPlotDIV',
            events: {
                drilldown: function(e) {
                    tooltipData[0] = protocolNames[e.point.x];
                    tooltipData[1] = e.point.x;
                    chart.setTitle({ text: drilldownTitle + e.point.name}, { text: '(n = ' + seriesDataN[e.point.x] +')' });
                    chart.yAxis[0].setTitle({text:'Number'});
                    chart.xAxis[0].setTitle({text:'DLP range (mGy.cm)'});
                    chart.xAxis[0].setCategories([], true);
                    chart.tooltip.options.formatter = function() {
                        var xyArr=[];
                        $.each(this.points,function(){
                            var linkText = 'acquisition_dlp_min=' + protocolBins[tooltipData[1]][this.x] + '&acquisition_dlp_max=' + protocolBins[tooltipData[1]][this.x+1] + '&acquisition_protocol=' + tooltipData[0];
                            xyArr.push('<a href="/openrem/ct/?' + linkText + '">' + this.y.toFixed(0) + ' exposures.<br/>Click to see.</a>');
                        });
                        return xyArr.join('<br/>');
                    }
                },
                drillup: function(e) {
                    chart.setTitle({ text: defaultTitle }, { text: '' });
                    chart.yAxis[0].setTitle({text:'Mean DLP (mGy.cm)'});
                    chart.xAxis[0].setTitle({text:'Protocol name'});
                    chart.xAxis[0].setCategories(protocolNames, true);
                    chart.tooltip.options.formatter = function() {
                        var xyArr=[];
                        $.each(this.points,function(){
                            var index = protocolNames.indexOf(this.x);
                            xyArr.push(this.x + '<br/>' + this.y.toFixed(1) + ' mGy.cm' + '<br/>(n=' + seriesDataN[index] + ')');
                        });
                        return xyArr.join('<br/>');
                    }
                }
            }
        },
        title: {
            text: 'Mean DLP per acquisition protocol'
        },
        legend: {
            enabled: false
        },
        xAxis: {
            categories: protocolNames,
            title: {
                useHTML: true,
                text: 'Protocol name'
            }
        },
        yAxis: {
            min: 0,
            title: {
                useHTML: true,
                text: 'Mean DLP (mGy.cm)'
            }
        },
        tooltip: {
            formatter: function () {
                var index = protocolNames.indexOf(this.x);
                var comment = this.x + '<br/>' + this.y.toFixed(1) + ' mGy.cm' + '<br/>(n=' + seriesDataN[index] + ')';
                return comment;
            },
            shared: true,
            useHTML: true
        },
        plotOptions: {
            column: {
                pointPadding: 0.2,
                borderWidth: 0
            }
        },
        series: [{
            name: 'Mean DLP per acquisition protocol',
            data: seriesData
        }],
        drilldown: {
            series: seriesDrilldown
        }
    });
});
</script>
{% endif %}

{% if studySummary %}
<!-- Plot of mean DLP per study description, with drilldown to histogram of DLP values for each study description. -->
<div class="panel-group" id="accordion">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree">
          Plot mean DLP for each study description in currently filtered data. Click this text to toggle between hidden and visible.
        </a>
      </h4>
    </div>
    <div id="collapseThree" class="panel-collapse collapse">
      <div class="panel-body">
         <div id="histogramStudyPlotDIV" style="width: 95%; height: 600px; margin: 0 0"></div>
         <p>Click on an individual column to show a histogram of data for that study description.</p>
      </div>
    </div>
  </div>
</div>

<script>
var studyNames     = [
                        {% for name in studySummary %}
                            "{{name.study_description}}"
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var studyCounts    = [
                        {% for study in studyHistogramData %}
                            [
                            {% for dataCounts in study.0 %}
                                {{dataCounts}}
                                {% if not forloop.last %},{% endif %}
                            {% endfor %}
                            ]
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var studyBins      = [
                        {% for studyEdges in studyHistogramData %}
                            [
                            {% for edges in studyEdges.1 %}
                                {{edges}}
                                {% if not forloop.last %},{% endif %}
                            {% endfor %}
                            ]
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var studySeriesData = [
                        {% for testData in studySummary %}
                            {{'{'}}name:studyNames[{{forloop.counter}}-1],y: {{testData.mean_dlp}},drilldown:studyNames[{{forloop.counter}}-1]{{'}'}}
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var studySeriesDataN = [
                        {% for testData in studySummary %}
                            '{{testData.num_acq}}'
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var studySeriesDrilldown   = [
                        {% for studyCountsArray in studyHistogramData %}
                            {id: studyNames[{{forloop.counter}}-1],name: studyNames[{{forloop.counter}}-1],useHTML: true,data: [
                            {% for dataCounts in studyCountsArray.0 %}
                                [studyBins[{{forloop.parentloop.counter}}-1][{{forloop.counter}}-1].toFixed(1).toString() + ' to < ' + studyBins[{{forloop.parentloop.counter}}-1][{{forloop.counter}}].toFixed(1).toString(),{{dataCounts}}]
                                {% if not forloop.last %},{% endif %}
                            {% endfor %}]}
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
</script>

<script type="text/javascript">
$(function () {

var drilldownTitle = 'Histogram of ';
var defaultTitle   = 'Mean DLP per study description';
var tooltipData = [2];

var chart = new Highcharts.Chart({
        chart: {
            type: 'column',
            renderTo: 'histogramStudyPlotDIV',
            events: {
                drilldown: function(e) {
                    tooltipData[0] = studyNames[e.point.x];
                    tooltipData[1] = e.point.x;
                    chart.setTitle({ text: drilldownTitle + e.point.name}, { text: '(n = ' + studySeriesDataN[e.point.x] +')' });
                    chart.yAxis[0].setTitle({text:'Number'});
                    chart.xAxis[0].setTitle({text:'DLP range (mGy.cm)'});
                    chart.xAxis[0].setCategories([], true);
                    chart.tooltip.options.formatter = function() {
                        var xyArr=[];
                        $.each(this.points,function(){
                            var linkText = 'study_dlp_min=' + studyBins[tooltipData[1]][this.x] + '&study_dlp_max=' + studyBins[tooltipData[1]][this.x+1] + '&study_description=' + tooltipData[0];
                            xyArr.push('<a href="/openrem/ct/?' + linkText + '">' + this.y.toFixed(0) + ' studies.<br/>Click to see.</a>');
                        });
                        return xyArr.join('<br/>');
                    }
                },
                drillup: function(e) {
                    chart.setTitle({ text: defaultTitle }, { text: '' });
                    chart.yAxis[0].setTitle({text:'Mean DLP (mGy.cm)'});
                    chart.xAxis[0].setTitle({text:'Study description'});
                    chart.xAxis[0].setCategories(studyNames, true);
                    chart.tooltip.options.formatter = function() {
                        var xyArr=[];
                        $.each(this.points,function(){
                            var index = studyNames.indexOf(this.x);
                            xyArr.push(this.x + '<br/>' + this.y.toFixed(1) + ' mGy.cm' + '<br/>(n=' + studySeriesDataN[index] + ')');
                        });
                        return xyArr.join('<br/>');
                    }
                }
            }
        },
        title: {
            text: 'Mean DLP per study description'
        },
        legend: {
            enabled: false
        },
        xAxis: {
            categories: studyNames,
            title: {
                useHTML: true,
                text: 'Study description'
            }
        },
        yAxis: {
            min: 0,
            title: {
                useHTML: true,
                text: 'Mean DLP (mGy.cm)'
            }
        },
        tooltip: {
            formatter: function () {
                var index = studyNames.indexOf(this.x);
                var comment = this.x + '<br/>' + this.y.toFixed(1) + ' mGy.cm' + '<br/>(n=' + studySeriesDataN[index] + ')';
                return comment;
            },
            shared: true,
            useHTML: true
        },
        plotOptions: {
            column: {
                pointPadding: 0.2,
                borderWidth: 0
            }
        },
        series: [{
            name: 'Mean DLP per study description',
            data: studySeriesData
        }],
        drilldown: {
            series: studySeriesDrilldown
        }
    });
});
</script>
{% endif %}

<!-- script to remove the hyper links from x-axis data labels in the plots -->
<script>
(function (H) {
    H.wrap(H.Point.prototype, 'init', function (proceed, series, options, x) {
        var point = proceed.call(this, series, options, x),
            chart = series.chart,
            tick = series.xAxis && series.xAxis.ticks[x],
            tickLabel = tick && tick.label;

        if (point.drilldown) {

            // Add the click event to the point label
            H.addEvent(point, 'click', function () {
                point.doDrilldown();
            });

            // Make axis labels clickable
            if (tickLabel) {
                if (!tickLabel._basicStyle) {
                    tickLabel._basicStyle = tickLabel.element.getAttribute('style');
                }
                tickLabel.addClass('highcharts-drilldown-axis-label')          .css({
                    'text-decoration': 'none',
                    'font-weight': 'normal',
                    'cursor': 'auto'
                    })
                    .on('click', function () {
                    if (point.doDrilldown) {
                        return false;
                    }
                });

            }
        } else if (tickLabel && tickLabel._basicStyle) {
        }

        return point;
    });
})(Highcharts);
</script>

{% endblock %}
