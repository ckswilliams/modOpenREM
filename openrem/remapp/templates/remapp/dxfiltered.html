{% extends "remapp/filteredbase.html" %}

{% block navbar %}
            <li><a href="/openrem/ct">CT</a></li>
            <li><a href="/openrem/rf">Fluoroscopy</a></li>
            <li><a href="/openrem/mg">Mammography</a></li>
            <li class="active"><a href="/openrem/dx">Radiography</a></li>
{% endblock %}

{% block toprow %}
      {% load pagination_tags %}
      <p>
        There are {{ filter.count }} studies in this list.
      </p>

        {% if admin.exportperm or admin.adminperm %}
        <ul>
          <li><a href="/openrem/exportdxcsv1/?{{ request.GET.urlencode }}">Export to CSV</a> </li>
          <li><a href="/openrem/exportdxxlsx1/?{{ request.GET.urlencode }}">Export to XLSX</a></li>
        </ul>
        {% else %}
        <p>
          Sorry, you don't have enough permissions to enable study export.
        </p>
        {% endif %}
{% endblock %}

{% block col2 %}


    {{ studyfilter }}

          <div class="panel panel-info">
            <div class="panel-heading">
              <h3 class="panel-title">Exam filter</h3>
            </div>
            <div class="panel-body">
                <i>Date format yyyy-mm-dd</i>
                <form action="" method="get" class="form-horizontal" role="form">
                        {% for field in filter.form %}
                            <div class="form-group">
                                <div class="col-xs-4">
                                    <label>{{ field.label_tag }}</label>
                                </div>
                                <div class="col-xs-8">
                                  {{ field.errors }}
                                  {{ field }}
                                </div>
                            </div>
                        {% endfor %}
                    </table>
                    <input type="submit" />
                </form> 
            </div>
          </div>
    
<script>
$('.datepicker').datepicker({
    format: "yyyy-mm-dd",
    autoclose: true,
    todayHighlight: true
    });
</script>

<script>
function formatDate(d) {
  var dd = d.getDate();
  if ( dd < 10 ) dd = '0' + dd;
  var mm = d.getMonth()+1;
  if ( mm < 10 ) mm = '0' + mm;
  var yyyy = d.getFullYear();
  return yyyy+'-'+mm+'-'+dd;
}
</script>

<script>
function getColours(noOfColours) {
    var colours = [];
    frequency = 5 / noOfColours; 
    for (var i = 0; i < noOfColours;++i) {
        if (noOfColours > 24) {
            r = Math.sin(frequency * i * 2 + 0) * (127) + 128;
            g = Math.sin(frequency * i * 2 + 1) * (127) + 128;
            b = Math.sin(frequency * i * 2 + 3) * (127) + 128;
        } else {
            r = Math.sin(frequency * i  + 0) * (127) + 128;
            g = Math.sin(frequency * i  + 1) * (127) + 128;
            b = Math.sin(frequency * i  + 3) * (127) + 128;
        }
        colour = 'rgb({r},{g},{b})';
        colour = colour.replace("{r}", Math.floor(r));
        colour = colour.replace("{g}", Math.floor(g));
        colour = colour.replace("{b}", Math.floor(b));
        colours.push(colour);
    }
    return colours;
}
</script>


{% endblock %}

{% block col1 %}
    {% autopaginate filter.qs 50 as filter_list %}
    {% paginate %}

    <table class="table table-bordered table-hover row-clickable">
        <row>
            <th>Institution</th><th>Make | Model | Station name</th><th>Date</th><th>Protocol | Accession number</th><th>Number of events</th><th>Total DAP (cGy.cm<sup>2</sup>)</th>
            {% if admin.adminperm %}
            <th>Delete?</th>
            {% endif %}
        </row>
        {% for exam in filter_list %}
        <tr>
            <td>
                <a href="/openrem/dx/{{ exam.id }}/">
                    {{ exam.generalequipmentmoduleattr_set.get.institution_name }}
                </a>
            </td>
            <td>
                <a href="/openrem/dx/{{ exam.id }}/">
                    {{ exam.generalequipmentmoduleattr_set.get.manufacturer }} |
                    {{ exam.generalequipmentmoduleattr_set.get.manufacturer_model_name }} |
                    {{ exam.generalequipmentmoduleattr_set.get.station_name }}
                </a>
            </td>
            <td>
                <a href="/openrem/dx/{{ exam.id }}/">
                    {{ exam.study_date|date:"Y-m-d" }} {{ exam.study_time|date:"H:i" }}</td>
                </a>
            <td>
                <a href="/openrem/dx/{{ exam.id }}/">
                    {{ exam.procedure_code_meaning }} |
                    {{ exam.accession_number }}
                </a>
            </td>
            <td>
                <a href="/openrem/dx/{{ exam.id }}/">
                    {{ exam.projectionxrayradiationdose_set.get.accumxraydose_set.get.accumintegratedprojradiogdose_set.get.total_number_of_radiographic_frames }}
                </a>
            </td>
            <td>
                <a href="/openrem/dx/{{ exam.id }}/">
                    {{ exam.projectionxrayradiationdose_set.get.accumxraydose_set.get.accumintegratedprojradiogdose_set.get.convert_gym2_to_cgycm2 | floatformat:1 }}
                </a>
            </td>
            {% if admin.adminperm %}
            <td>
              <a href="{% url 'study_delete' exam.id %}">Delete</a>
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </table>

    {% paginate %}
 
{% endblock %}

{% block plotdata %}
{% if request.user.userprofile.plotCharts %}

{% if request.user.userprofile.plotDXAcquisitionMeanDAP %}
<!-- HTML to include div container for acquisition plot -->
<div class="panel-group" id="accordion">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
          Plot of currently filtered data. Click this text to toggle between hidden and visible.
        </a>
      </h4>
    </div>
    <div id="collapseOne" class="panel-collapse collapse">
      <div class="panel-body">
         <div id="container" style="width: 95%; height: 600px; margin: 0 0"></div>
         <p>Click on an individual column to show a histogram of data for that acquisition protocol.</p>
         <p>Click on a histogram bin tooltip to see the studies that contain the acquisitions in the bin.
         Note that this will include acquisitions at the upper bin boundary, so in some cases may display
         more data than shown in the histogram bin.</p>
      </div>
    </div>
  </div>
</div>
<!-- End of HTML to include div for acquisition plot -->
{% endif %}

{% if request.user.userprofile.plotDXAcquisitionFreq %}
<!-- HTML to include div container for acquisition pie chart -->
<div class="panel-group" id="accordion">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseProtocolPieChart">
          Pie chart showing a breakdown of acquisition protocol frequency.
        </a>
      </h4>
    </div>
    <div id="collapseProtocolPieChart" class="panel-collapse collapse">
      <div class="panel-body">
         <div id="piechartProtocolDIV" style="width: 95%; height: 600px; margin: 0 0"></div>
      </div>
    </div>
  </div>
</div>
<!-- End of HTML to include div container for acquisition pie chart -->
{% endif %}

{% if request.user.userprofile.plotDXStudyPerDayAndHour %}
<!-- HTML to include div container for pie chart of studies per week day pie chart -->
<div class="panel-group" id="accordion">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseStudyWorkloadPieChart">
          Pie chart showing a breakdown of number of studies per weekday.
        </a>
      </h4>
    </div>
    <div id="collapseStudyWorkloadPieChart" class="panel-collapse collapse">
      <div class="panel-body">
         <div id="piechartStudyWorkloadDIV" style="width: 95%; height: 600px; margin: 0 0"></div>
         <p>Click on a segment to be taken to a pie chart showing the breakdown per hour for that weekday.</p>
      </div>
    </div>
  </div>
</div>
<!-- End of HTML to include div container for studies per week day pie chart -->
{% endif %}

{% if request.user.userprofile.plotDXAcquisitionMeanDAPOverTime %}
<!-- HTML to include div container for mean acquisition protocol DAP per week -->
<div class="panel-group" id="accordion">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseMonthlyAcquisitionMeanChart">
          Line plot showing monthly mean DAP of each acquisition protocol over time.
        </a>
      </h4>
    </div>
    <div id="collapseMonthlyAcquisitionMeanChart" class="panel-collapse collapse">
      <div class="panel-body">
         <div id="linechartMonthlyAcquisitionMeanDIV" style="width: 95%; height: 600px; margin: 0 0"></div>
         <p>Click on the legend entries to show or hide the corresponding series. Click and drag the mouse over a date range to zoom in.</p>
      </div>
    </div>
  </div>
</div>
<!-- End of HTML to include div container for mean acquisition protocol DAP per week -->
{% endif %}

<!-- Include JavaScript to enable highcharts plots -->
<script src="{{ STATIC_URL }}js/highcharts.js"></script>
<script src="{{ STATIC_URL }}js/exporting.js"></script>
<script src="{{ STATIC_URL }}js/drilldown.js"></script>
<!-- End of include JavaScript for the plots -->


<!-- JavaScript function to sort a list of objects by the 'y' object.
     This must be positioned above the functions first use. -->
<script>
function sort_by_y(a,b) {
    return ((a.y < b.y) ? -1 : ((a.y > b.y) ? 1 : 0)); // a[1] for col. 2 etc...
}
function sort_by_name(a,b) {
    return ((a.name < b.name) ? -1 : ((a.name > b.name) ? 1 : 0)); // a[1] for col. 2 etc...
}
</script>
<!-- End of JavaScript function to sort a list of objects by the 'y' object -->


<!-- JavaScript for acquisition plot -->
<script>
var protocolNames     = [
                        {% for name in acquisitionSummary %}
                            "{{name.projectionxrayradiationdose__irradeventxraydata__acquisition_protocol}}"
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var protocolCounts    = [
                        {% for protocol in acquisitionHistogramData %}
                            [
                            {% for dataCounts in protocol.0 %}
                                {{dataCounts}}
                                {% if not forloop.last %},{% endif %}
                            {% endfor %}
                            ]
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var protocolBins      = [
                        {% for protocolEdges in acquisitionHistogramData %}
                            [
                            {% for edges in protocolEdges.1 %}
                                {{edges}}
                                {% if not forloop.last %},{% endif %}
                            {% endfor %}
                            ]
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var seriesData        = [
                        {% for testData in acquisitionSummary %}
                            {{'{'}}name:protocolNames[{{forloop.counter}}-1],y: {{testData.mean_dap}}*1000000,drilldown:protocolNames[{{forloop.counter}}-1]{{'}'}}
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var seriesDataN       = [
                        {% for testData in acquisitionSummary %}
                            '{{testData.num_acq}}'
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
var seriesDrilldown   = [
                        {% for protocolCountsArray in acquisitionHistogramData %}
                            {id: protocolNames[{{forloop.counter}}-1],name: protocolNames[{{forloop.counter}}-1],useHTML: true,data: [
                            {% for dataCounts in protocolCountsArray.0 %}
                                [protocolBins[{{forloop.parentloop.counter}}-1][{{forloop.counter}}-1].toFixed(1).toString() + ' \u2264 x {% if not forloop.last %}<{% else %}\u2264{% endif %} ' + protocolBins[{{forloop.parentloop.counter}}-1][{{forloop.counter}}].toFixed(1).toString(),{{dataCounts}}]
                                {% if not forloop.last %},{% endif %}
                            {% endfor %}]}
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];
</script>

{% if request.user.userprofile.plotDXAcquisitionMeanDAP %}
<script type="text/javascript">
$(function () {

var drilldownTitle = 'Histogram of ';
var defaultTitle   = 'Mean DAP per acquisition protocol';
var tooltipData = [2];

var chartDAPperAcquisition = new Highcharts.Chart({
        chart: {
            type: 'column',
            renderTo: 'container',
            events: {
                drilldown: function(e) {
                    tooltipData[0] = protocolNames[e.point.x];
                    tooltipData[1] = e.point.x;
                    chartDAPperAcquisition.setTitle({ text: drilldownTitle + e.point.name}, { text: '(n = ' + seriesDataN[e.point.x] +')' });
                    chartDAPperAcquisition.yAxis[0].setTitle({text:'Number'});
                    chartDAPperAcquisition.xAxis[0].setTitle({text:'DAP range (cGy.cm<sup>2</sup>)'});
                    chartDAPperAcquisition.xAxis[0].setCategories([], true);
                    chartDAPperAcquisition.xAxis[0].update({labels:{rotation:0}});
                    chartDAPperAcquisition.tooltip.options.formatter = function() {
                        var xyArr=[];
                        $.each(this.points,function(){
                            var tooltipFilters = '{% for field in filter.form %}{% if field.name != 'acquisition_dap_min' and field.name != 'acquisition_dap_max' and field.name != 'acquisition_protocol' and field.name != 'o' and field.value %}&{{ field.name }}={{ field.value }}{% endif %}{% endfor %}';
                            var linkText = 'acquisition_dap_min=' + (protocolBins[tooltipData[1]][this.x])/1000000 + '&acquisition_dap_max=' + (protocolBins[tooltipData[1]][this.x+1])/1000000 + '&acquisition_protocol=' + tooltipData[0];
                            xyArr.push('<table style="text-align: center"><tr><td>' + this.y.toFixed(0) + ' exposures</td></tr><tr><td><a href="/openrem/dx/hist/?acquisitionhist=1&' + linkText + tooltipFilters + '">Click to view</a></td></tr></table>');
                        });
                        return xyArr.join('<br/>');
                    }
                },
                drillup: function(e) {
                    chartDAPperAcquisition.setTitle({ text: defaultTitle }, { text: '' });
                    chartDAPperAcquisition.yAxis[0].setTitle({text:'Mean DAP (cGy.cm<sup>2</sup>)'});
                    chartDAPperAcquisition.xAxis[0].setTitle({text:'Protocol name'});
                    chartDAPperAcquisition.xAxis[0].setCategories(protocolNames, true);
                    chartDAPperAcquisition.xAxis[0].update({labels:{rotation:90}});
                    chartDAPperAcquisition.tooltip.options.formatter = function() {
                        var xyArr=[];
                        $.each(this.points,function(){
                            var index = protocolNames.indexOf(this.x);
                            xyArr.push(this.x + '<br/>' + this.y.toFixed(1) + ' cGy.cm<sup>2</sup>' + '<br/>(n=' + seriesDataN[index] + ')');
                        });
                        return xyArr.join('<br/>');
                    }
                }
            }
        },
        title: {
            text: 'Mean DAP per acquisition protocol'
        },
        legend: {
            enabled: false
        },
        xAxis: {
            categories: protocolNames,
            title: {
                useHTML: true,
                text: 'Protocol name'
            },
            labels: {
                rotation:90
            }
        },
        yAxis: {
            min: 0,
            title: {
                useHTML: true,
                text: 'Mean DAP (cGy.cm<sup>2</sup>)'
            }
        },
        tooltip: {
            formatter: function () {
                var index = protocolNames.indexOf(this.x);
                var comment = this.x + '<br/>' + this.y.toFixed(1) + ' cGy.cm<sup>2</sup>' + '<br/>(n=' + seriesDataN[index] + ')';
                return comment;
            },
            shared: true,
            useHTML: true
        },
        plotOptions: {
            column: {
                pointPadding: 0.2,
                borderWidth: 0
            }
        },
        series: [{
            name: 'Mean DAP per acquisition protocol',
            data: seriesData
        }],
        drilldown: {
            series: seriesDrilldown
        }
    });
});
</script>
<!-- End of JavaScript for acquisition plot -->
{% endif %}


{% if request.user.userprofile.plotDXAcquisitionFreq %}
<!-- JavaScript for acquisition pie chart -->
<script>
var urlStart = '/openrem/dx/?{% for field in filter.form %}{% if field.name != 'acquisition_protocol' and field.name != 'o' and field.value %}&{{ field.name }}={{ field.value }}{% endif %}{% endfor %}&acquisition_protocol=';
var protocolPiechartData = new Array(protocolNames.length);
for(var i=0; i<protocolNames.length; i++) {
    protocolPiechartData[i] = {name:protocolNames[i], y:parseInt(seriesDataN[i]), url:urlStart+protocolNames[i]};
}
protocolPiechartData.sort(sort_by_y);

protocolColours = getColours(protocolNames.length);
for(var i=0; i<protocolNames.length; i++) {
    protocolPiechartData[i].color = protocolColours[i];
}

$(function () {

var chartAcqFrequency = new Highcharts.Chart({
        chart: {
            renderTo: 'piechartProtocolDIV',
            plotBackgroundColor: null,
            plotBorderWidth: 1,
            plotShadow: false
        },
        title: {
            text: ''
        },
        tooltip: {
            pointFormat: '{point.percentage:.1f} %<br/>n={point.y}'
        },
        plotOptions: {
            pie: {
                allowPointSelect: false,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    format: '<b>{point.name}</b>: {point.percentage:.1f} % (n={point.y})',
                    style: {
                        color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                    }
                }
            }
        },
        series: [{
            type: 'pie',
            name: 'Study frequency',
            point: {
                events: {
                    click: function(e) {
                        location.href = e.point.url;
                        e.preventDefault();
                    }
                }
            },
            data: protocolPiechartData
        }]
    });
});
</script>
<!-- End of JavaScript for acquisition pie chart -->
{% endif %}

{% if request.user.userprofile.plotDXStudyPerDayAndHour %}
<!-- JavaScript for studies per weekday pie chart with drilldown to hourly breakdown -->
<script>
var dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

var studiesPerHourEachWeekday = [
                      {% for dayCounts in studiesPerHourInWeekdays %}
                          [
                          {% for hourCounts in dayCounts %}
                              {{hourCounts}}
                              {% if not forloop.last %},{% endif %}
                          {% endfor %}
                          ]
                          {% if not forloop.last %},{% endif %}
                      {% endfor %}
                      ];

var studiesPerWeekday = new Array(7);
for(var i=0; i<7; i++) {
    var tempTotal = 0;
    for(var j=0; j<24; j++) {
        tempTotal = tempTotal + studiesPerHourEachWeekday[i][j];
    }
    studiesPerWeekday[i] = tempTotal;
}

var hourColours = getColours(24);
var seriesDrillDownPieChart   = [
                        {% for dayCounts in studiesPerHourInWeekdays %}
                            {id:dayNames[{{forloop.counter}}-1], name:dayNames[{{forloop.counter}}-1], useHTML:true, type:'pie', data: [
                            {% for hourCounts in dayCounts %}
                                {{'{'}}name:'{{forloop.counter|add:"-1"|stringformat:"02d"}}:00', y:studiesPerHourEachWeekday[{{forloop.parentloop.counter}}-1][{{forloop.counter}}-1],color:hourColours[{{forloop.counter}}]{{'}'}}{% if not forloop.last %},{% endif %}
                            {% endfor %}]}
                            {% if not forloop.last %},{% endif %}
                        {% endfor %}
                        ];

var dayColours = getColours(7);
var studyWorkloadPieChartData= new Array(7);
for(var i=0; i<7; i++) {
    studyWorkloadPieChartData[i] = {name:dayNames[i], y:studiesPerWeekday[i], color:dayColours[i], drilldown:dayNames[i]};
}

$(function () {

var chartWorkload = new Highcharts.Chart({
        chart: {
            renderTo: 'piechartStudyWorkloadDIV',
            plotBackgroundColor: null,
            plotBorderWidth: 1,//null,
            plotShadow: false,
            events: {
                drilldown: function(e) {
                    chartWorkload.setTitle({ text: 'Studies per hour,<br>'+dayNames[e.point.x], align:'left', verticalAlign:'top', y:50, x:50 });
                },
                drillup: function(e) {
                    chartWorkload.setTitle({ text: 'Studies per<br>day of the week', align:'center', verticalAlign:'middle', y:70, x:0 });
                }
            }
        },
        title: {
            text: 'Studies per<br>day of the week',
            align: 'center',
            verticalAlign: 'middle',
            y: 70
        },
        tooltip: {
            pointFormat: '{point.percentage:.1f} %<br/>n={point.y}'
        },
        plotOptions: {
            pie: {
                allowPointSelect: false,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    format: '<b>{point.name}</b>: {point.percentage:.1f} % (n={point.y})',
                    style: {
                        color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                    }
                }
            }
        },
        series: [{
            type: 'pie',
            startAngle:-90,
            endAngle:90,
            center: ['50%','75%'],
            innerSize: '50%',
            data: studyWorkloadPieChartData
        }],
        drilldown: {
            series:seriesDrillDownPieChart
        }
    });
});
</script>
<!-- End of JavaScript for studies per week day pie chart -->
{% endif %}

{% if request.user.userprofile.plotDXAcquisitionMeanDAPOverTime %}
<!-- JavaScript for mean DAP per acquisition protocol per month -->
<script>
dateAxis = [
{% for dateEntries in acquisitionDAPoverTime.0 %}
    "{{ dateEntries.0.date|date:"d/m/Y" }}"
    {% if not forloop.last %},{% endif %}
{% endfor %}
];

// Create the same colours as for the study pie chart, so that the colours
// are the same for the studies in the pie chart and this plot.
var protocolLineColours =  new Array(protocolNames.length);
protocolPiechartData.sort(sort_by_name);
for(var i=0; i<protocolNames.length; i++) {
    protocolLineColours[i] = protocolPiechartData[i].color;
}
protocolPiechartData.sort(sort_by_y);

var urlStart = '/openrem/dx/?{% for field in filter.form %}{% if field.name != 'acquisition_protocol' and field.name != 'date_before' and field.name != 'date_after' and field.name != 'o' and field.value %}&{{ field.name }}={{ field.value }}{% endif %}{% endfor %}&acquisition_protocol=';

meanDAPperMonth = [
{% for protocolData in acquisitionDAPoverTime %}
    {{'{'}}name:protocolNames[{{forloop.counter}}-1],
        color:protocolLineColours[{{forloop.counter}}-1],
        marker:{{'{'}}enabled:true{{'}'}},
        point: {{'{'}}
            events: {{'{'}}
                    click: function(e) {{'{'}}
                        location.href = e.point.url;
                        e.preventDefault();
                    {{'}'}}
            {{'}'}}
        {{'}'}},
        data:[
    {% for monthEntries in protocolData %}
        {{'{'}}y:{% if monthEntries.1 %}{{ monthEntries.1 }}*1000000{% else %}null{% endif %},url:urlStart+protocolNames[{{forloop.parentloop.counter}}-1]+'&date_after='+formatDate(new Date({{monthEntries.0.year}},{{monthEntries.0.month}}-1,{{monthEntries.0.day}}))+'&date_before='+ formatDate(new Date((new Date ((new Date({{monthEntries.0.year}},{{monthEntries.0.month}}-1,{{monthEntries.0.day}})).setMonth((new Date({{monthEntries.0.year}},{{monthEntries.0.month}}-1,{{monthEntries.0.day}})).getMonth()+1))).setDate((new Date ((new Date({{monthEntries.0.year}},{{monthEntries.0.month}}-1,{{monthEntries.0.day}})).setMonth((new Date({{monthEntries.0.year}},{{monthEntries.0.month}}-1,{{monthEntries.0.day}})).getMonth()+1))).getDate()-1))){{'}'}}
        {% if not forloop.last %},{% endif %}
    {% endfor %}
    ]{{'}'}}
    {% if not forloop.last %},{% endif %}
{% endfor %}
];

$(function () {
var chartMonthlyAcquisitionMeanDAP = new Highcharts.Chart({
        chart: {
            renderTo: 'linechartMonthlyAcquisitionMeanDIV',
            zoomType: 'x'
        },
        title: {
            text: ''
        },
        tooltip: {
            pointFormat: '{series.name}<br/>{point.y:.1f} cGy.cm<sup>2</sup>',
            useHTML: true
        },
        xAxis: {
            categories: dateAxis,
            minTickInterval: 1,
            labels: {
                rotation:90
            }
        },
        yAxis: {
            title: {
                text: 'Mean DAP over the month (cGy.cm<sup>2</sup>)',
                useHTML: true
            },
            floor: 0,
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        legend: {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'middle',
            borderWidth: 0
        },
        series: meanDAPperMonth
    });
});

</script>
<!-- End of JavaScript for mean DAP per acquisition protocol per week -->
{% endif %}

<!-- JavaScript to remove the hyper links from x-axis data labels in the plots -->
<script>
(function (H) {
    H.wrap(H.Point.prototype, 'init', function (proceed, series, options, x) {
        var point = proceed.call(this, series, options, x),
            chart = series.chart,
            tick = series.xAxis && series.xAxis.ticks[x],
            tickLabel = tick && tick.label;

        if (point.drilldown) {

            // Add the click event to the point label
            H.addEvent(point, 'click', function () {
                point.doDrilldown();
            });

            // Make axis labels click-able
            if (tickLabel) {
                if (!tickLabel._basicStyle) {
                    tickLabel._basicStyle = tickLabel.element.getAttribute('style');
                }
                tickLabel.addClass('highcharts-drilldown-axis-label')          .css({
                    'text-decoration': 'none',
                    'font-weight': 'normal',
                    'cursor': 'auto'
                    })
                    .on('click', function () {
                    if (point.doDrilldown) {
                        return false;
                    }
                });

            }
        } else if (tickLabel && tickLabel._basicStyle) {
        }

        return point;
    });
})(Highcharts);
</script>
<!-- End of JavaScript to remove the hyper links from x-axis data labels in the plots -->
{% endif %}
{% endblock %}
