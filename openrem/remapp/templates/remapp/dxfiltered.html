{% extends "remapp/filteredbase.html" %}

{% block navbar %}
            <li><a href="/openrem/ct">CT</a></li>
            <li><a href="/openrem/rf">Fluoroscopy</a></li>
            <li><a href="/openrem/rf">Mammography</a></li>
            <li class="active"><a href="/openrem/dx">Radiography</a></li>
{% endblock %}

{% block toprow %}
      {% load pagination_tags %}
      <p>
        There are {{ filter.count }} studies in this list.
      </p>

        {% if admin.exportperm or admin.adminperm %}
        <ul>
          <li><a href="/openrem/exportdxcsv1/?{{ request.GET.urlencode }}">Export to CSV</a> </li>
          <li><a href="/openrem/exportdxxlsx1/?{{ request.GET.urlencode }}">Export to XLSX</a></li>
        </ul>
        {% else %}
        <p>
          Sorry, you don't have enough permissions to enable study export.
        </p>
        {% endif %}
{% endblock %}

{% block col2 %}


    {{ studyfilter }}

          <div class="panel panel-info">
            <div class="panel-heading">
              <h3 class="panel-title">Exam filter</h3>
            </div>
            <div class="panel-body">
                <i>Date format yyyy-mm-dd</i>
                <form action="" method="get" class="form-horizontal" role="form">
                        {% for field in filter.form %}
                            <div class="form-group">
                                <div class="col-xs-4">
                                    <label>{{ field.label_tag }}</label>
                                </div>
                                <div class="col-xs-8">
                                  {{ field.errors }}
                                  {{ field }}
                                </div>
                            </div>
                        {% endfor %}
                    </table>
                    <input type="submit" />
                </form> 
            </div>
          </div>
    
<script>
$('.datepicker').datepicker({
    format: "yyyy-mm-dd",
    autoclose: true,
    todayHighlight: true
    });
</script>

{% endblock %}

{% block col1 %}
    {% autopaginate filter.qs 50 as filter_list %}
    {% paginate %}

    <table class="table table-striped">
        <th>Institution</th><th>Make | Model | Station name</th><th>Date</th><th>Protocol | Accession number</th><th>Number of events</th><th>Total DAP (cGy.cm<sup>2</sup>)</th>
        {% if admin.adminperm %}
        <th>Delete?</th>
        {% endif %}
        {% for exam in filter_list %}
        <tr>
            <td>{{ exam.general_equipment_module_attributes_set.get.institution_name }}</td>
            <td>
                {{ exam.general_equipment_module_attributes_set.get.manufacturer }} | 
                {{ exam.general_equipment_module_attributes_set.get.manufacturer_model_name }} |
                {{ exam.general_equipment_module_attributes_set.get.station_name }}
            </td>
            <td>{{ exam.study_date|date:"Y-m-d" }} {{ exam.study_time|date:"H:i" }}</td>
            <td>
                <a href="/openrem/dx/{{ exam.id }}/">{{ exam.procedure_code_meaning }}</a> |
                {{ exam.accession_number }}
            </td>
            <td>{{ exam.projection_xray_radiation_dose_set.get.irradiation_event_xray_data_set.count }}</td>
            <td>{{ exam.projection_xray_radiation_dose_set.get.accumulated_xray_dose_set.get.accumulated_projection_xray_dose_set.get.convert_gym2_to_cgycm2 | floatformat:1 }}</td>
            {% if admin.adminperm %}
            <td>
              <a href="{% url 'study_delete' exam.id %}">Delete</a>
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </table>

    {% paginate %}

 
{% endblock %}


{% block plotdata %}
<script src="{{ STATIC_URL }}js/highcharts.js"></script>
<script src="{{ STATIC_URL }}js/exporting.js"></script>
<script src="{{ STATIC_URL }}js/drilldown.js"></script>

<div id="container" style="min-width: 310px; height: 600px; margin: 0 auto"></div>

<script>
var protocolNames     = [{% for name in plotNames %}"{{name}}",{% endfor %}];
var protocolCounts    = [{% for protocol in histogramCounts %}[{% for dataCounts in protocol %}{{dataCounts}},{% endfor %}],{% endfor %}]
var protocolBins      = [{% for protocolEdges in histogramBinEdges %}[{% for edges in protocolEdges %}{{edges}},{% endfor %}],{% endfor %}]
var protocolBinLabels = [{% for dataCounts in protocolCountsArray %}protocolBins[{{forloop.parentloop.counter}}-1][{{forloop.counter}}-1].toFixed(1).toString() + ' to < ' + protocolBins[{{forloop.parentloop.counter}}-1][{{forloop.counter}}].toFixed(1).toString(),{% endfor %}]

</script>

		<script type="text/javascript">
$(function () {

var drilldownTitle = 'Histogram of ';
var defaultTitle   = 'Mean DAP per acquisition protocol';

//    $('#container').highcharts({
var chart = new Highcharts.Chart({
        chart: {
            type: 'column',
            renderTo: 'container',
            events: {
                drilldown: function(e) {
                    chart.setTitle({ text: drilldownTitle + e.point.name });
                    chart.yAxis[0].setTitle({text:'Number'});
                    chart.xAxis[0].setTitle({text:'DAP range (cGy.cm<sup>2</sup>)'});
                    chart.xAxis[0].setCategories(protocolBinLabels, true);
                },
                drillup: function(e) {
                    chart.setTitle({ text: defaultTitle });
                    chart.yAxis[0].setTitle({text:'Mean DAP (cGy.cm<sup>2</sup>)'});
                    chart.xAxis[0].setTitle({text:'Protocol name'});
                    chart.xAxis[0].setCategories(protocolNames, true);
                }
            }
        },
        title: {
            text: 'Mean DAP per acquisition protocol'
        },
        legend: {
            enabled: false
        },
        xAxis: {
            type: 'category',
            title: {
                useHTML: true,
                text: 'Protocol name'
            }
        },
        yAxis: {
            min: 0,
            title: {
                useHTML: true,
                text: 'Mean DAP (cGy.cm<sup>2</sup>)'
            }
        },
        tooltip: {
            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
            pointFormat: '<tr><td style="padding:0"><b>{point.y:.1f} cGy.cm<sup>2</sup></b></td></tr>',
            footerFormat: '</table>',
            shared: true,
            useHTML: true
        },
        plotOptions: {
            column: {
                pointPadding: 0.2,
                borderWidth: 0
            }
        },
        series: [{
            name: 'Mean DAP per acquisition protocol',
            data: [
                   {% for testData in plotData %}
                       {{'{'}}
                       name:protocolNames[{{forloop.counter}}-1],
                       y: {{testData}},
                       drilldown:protocolNames[{{forloop.counter}}-1]
                       {{'}'}},
                   {% endfor %}
                  ]
        }],
        drilldown: {
            series: [
                {% for protocolCountsArray in histogramCounts %}
                    {
                        id: protocolNames[{{forloop.counter}}-1],
                        name: protocolNames[{{forloop.counter}}-1],
                        useHTML: true,
                        data: [
                            {% for dataCounts in protocolCountsArray %}
                                [protocolBins[{{forloop.parentloop.counter}}-1][{{forloop.counter}}-1].toFixed(1).toString() + ' to < ' + protocolBins[{{forloop.parentloop.counter}}-1][{{forloop.counter}}].toFixed(1).toString(),{{dataCounts}}],
                            {% endfor %}
                        ]
                    },
                {% endfor %}
            ],
            xAxis: {
                categories: [
                       {% for testName in plotNames %}
                           '{{testName}}',
                       {% endfor %}
                ]
            },
            yAxis: {
                min: 0,
                title: {
                    useHTML: true,
                    text: 'Number'
                }
            }


        }
    });
});
		</script>

{% endblock %}
