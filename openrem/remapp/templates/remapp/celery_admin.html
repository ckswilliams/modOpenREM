{% extends "remapp/base.html" %}

{% block headextras %}
  <script src="{{ STATIC_URL }}js/sorttable.js"></script>
{% endblock %}

{% block confnav %}<li class="dropdown active">{% endblock %}

{% block navhelp %}
        <li>
            <a href="https://docs.openrem.org/en/{{ admin.docsversion }}/celery_management.html"
               target="_blank" data-toggle="tooltip" title="Celery management documentation - opens in a new tab">
                Celery management documentation
            </a>
        </li>
{% endblock %}

{% block mainblock %}

{% if admin.admingroup %}
  <div class="row col-md-offset-2">
    <h3>Celery administration </h3>
  </div>

  <div class="row">
  <div class="col-md-8 col-md-offset-2">
          <script>
              function updateSort(heading, source) {
                  if (typeof source === "undefined") {source = null;}

                  sort_info.heading = heading;

                  if (source === 'user_click') {
                      // It's a user-generated call and the headings already match
                      // so reverse the sorting direction
                      sort_info.direction = sort_info.direction === "ascending" ? "descending" : "ascending";
                      sorttable.innerSortFunction.apply(document.getElementById(heading), []);
                  }

                  if (sort_info.direction === "ascending") {
                      sorttable.innerSortFunction.apply(document.getElementById(heading), []);
                  } else {
                      sorttable.innerSortFunction.apply(document.getElementById(heading), []);
                      sorttable.innerSortFunction.apply(document.getElementById(heading), []);
                  }
              }

              sort_info = {
                  heading:"uuid",
                  direction:"ascending"
              };

              $(document).ready(
                      function tasks_update( json ){
                          $.ajax({
                              url: "{% url 'celery_tasks' %}",
                              data: {
                                  csrfmiddlewaretoken: '{{ csrf_token }}'
                              },
                              type: "POST",
                              success: function( data ){
                                  $( '#tasks' ).html( data );
                                  setTimeout(function(){
                                      tasks_update();
                                  }, 2000);
                              }
                          })
                      }
              )
          </script>
  <p>
    Celery is the task manager that runs tasks that run in the background. The current active tasks can be found below,
    along with tasks that have finished. This interface relies on Flower being installed and running, so look at the
    docs to find out more: link to docs.
  </p>
    <p>
      If Flower has been started after the task was started, then the task will not appear in this table until it
      finishes or is aborted somewhere else.
  </p>
  </div></div>
    <div class="row">
  <div class="col-md-8 col-md-offset-2">

  <p id="tasks">
    The list of tasks should appear here...
  </p>
  </div>
  </div>


{% else %}

  <div class="row col-md-offset-2">
    <h3>Celery administration </h3>
  </div>

  <div class="row">
  <div class="col-md-8 col-md-offset-2">
  <p>
    This function can only be accessed if you are logged in to OpenREM with admin
    permissions.
  </p>
  </div>
  </div>

{% endif %}




{% endblock %}


