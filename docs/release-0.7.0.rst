#############################
Upgrade to OpenREM 0.7.0 beta
#############################

.. Warning::

    This is a beta version for developer testing. It is not suitable for general use, and the instructions below are
    likely to be incorrect.

****************
Headline changes
****************

* System

    * Django upgraded to version 1.8
    * Median function added to the database if using PostgreSQL
    * New user-defined display name for each unique system so that rooms with the same DICOM station name are displayed separately
    * Patient name and ID can optionally be stored in system, available for searching and export, but not displayed
    * Patient name, ID and accession number can be stored as a one-way hash, and remain searchable
    * Permission system has become more granular
    * System can now accept non-ASCII characters in protocol names etc
    * Menus have been tidied up

* Charts

    * Bar chart data points sorted by frequency, value or name in ascending or descending order
    * New chart of DLP per requested procedure type and requested procedure frequency
    * Chart data returned using AJAX to make pages more responsive
    * Chart plotting options available via Config menu
	* Charts can now be made full-screen

* DICOM Networking

    * Configuring and running DICOM Store SCP is now managed in the web interface
    * Query retrieve function is now built in to query PACS systems or modalities via the Import menu

* Exports

    * Patient sex is included in all exports
    * Filters generated by navigating through charts can now be used to filter export data

Updates since beta 7
====================
* Full screen charts
* Test implementation of QR SCU from the command line
* New docs and bug fixes

****************************
Upgrading from version 0.6.0
****************************

* Back up your database

    * For PostgreSQL you can refer to :doc:`backupRestorePostgreSQL`
    * For a non-production SQLite3 database, simply make a copy of the database file

* The 0.7.0 upgrade must be made from a 0.6.0 (or later) database, and a schema migration is required:

.. sourcecode:: bash

    pip install openrem==0.7.0b8

In a shell/command window, move into the openrem folder:

* Ubuntu linux: ``/usr/local/lib/python2.7/dist-packages/openrem/``
* Other linux: ``/usr/lib/python2.7/site-packages/openrem/``
* Linux virtualenv: ``lib/python2.7/site-packages/openrem/``
* Windows: ``C:\Python27\Lib\site-packages\openrem\``
* Windows virtualenv: ``Lib\site-packages\openrem\``

Delete all numbered migration files in openrem's ``migrations`` folder, **leaving the 0002 files ending in .inactive**

If there is no file named ``__init__.py`` in the ``migrations`` folder, please create it.

.. sourcecode:: bash

    python manage.py migrate --fake-initial
    python manage.py makemigrations remapp
    python manage.py migrate remapp --fake

Now rename the file

.. sourcecode:: console

    remapp/migrations/0002_openrem_upgrade_add_new_tables_and_populate_and_add_median_function.py.inactive

to:

.. sourcecode:: console

    remapp/migrations/0002_openrem_upgrade_add_new_tables_and_populate_and_add_median_function.py

and then run

.. sourcecode:: console

    python manage.py migrate remapp

********************************************
Upgrading from version 0.7.0 beta 7 or later
********************************************

You will need to do a database migration.

.. sourcecode:: bash

    pip install openrem==0.7.0b8

From the openrem folder (see above):

.. sourcecode:: bash

    python manage.py makemigrations remapp
    python manage.py migrate remapp



Restart all the services!
=========================

Some of the commands and services have changed - follow the guide at :doc:`startservices`.



Further instructions
====================


Daemonising Celery
------------------

In a production environment, Celery will need to start automatically and
not depend on a particular user being logged in. Therefore, much like
the webserver, it will need to be daemonised. For now, please refer to the
instructions and links at http://celery.readthedocs.org/en/latest/tutorials/daemonizing.html.

