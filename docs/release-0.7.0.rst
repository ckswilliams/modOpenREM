#############################
Upgrade to OpenREM 0.7.0 beta
#############################

.. Warning::

    This is a beta version for developer testing. It is not suitable for general use, and the instructions below are
    likely to be incorrect.

****************
Headline changes
****************

* System

    * Django upgraded to version 1.8
    * Median function added to the database if using PostgreSQL
    * New user-defined display name for each unique system so that rooms with the same DICOM station name are displayed separately
    * Patient name and ID can optionally be stored in system, available for searching and export, but not displayed
    * Patient name, ID and accession number can be stored as a one-way hash, and remain searchable
    * Permission system has become more granular
    * System can now accept non-ASCII characters in protocol names etc
    * Menus have been tidied up
    * Settings file has been updated

* Charts and interface

    * Bar chart data points sorted by frequency, value or name in ascending or descending order
    * New chart of DLP per requested procedure type and requested procedure frequency
    * Chart data returned using AJAX to make pages more responsive
    * Chart plotting options available via Config menu
    * Charts can now be made full-screen
    * CTDIw phantom size is displayed with the CTDIvol measurement on the CT study detail page
    * Charts show a series called "Blank" when the series name is ``None``
    * Queries for chart data now faster in most situations
    * Histograms can be disabled or enabled for bar charts
    * User-specified number of histogram bins from 2 to 40
    * Mammography chart of average glandular dose vs. compressed thickness
    * Mammography chart showing the number of studies carried out per weekday
    * Fluoroscopy chart of average DAP for each study description
    * Fluoroscopy chart of the frequency of each study description
    * Fluoroscopy chart showing the number of studies carried out per weekday

* DICOM Networking

    * Query retrieve function is now built in to query PACS systems or modalities via the Import menu
    * Configuring and running DICOM Store SCP is available and managed in the web interface, but not recommended
    * Documentation improved

* Imports

    * Mammography RDSRs import correctly
    * Mammography imports from images **now create an accumulated AGD value per breast**
    * GE Senographe DS compression **now recorded correctly in Newtons** for new imports
    * Philips Allura fluoroscopy RDSRs import correctly, including calculating the exposure time
    * Bi-plane fluoroscopy imports can now be displayed in the web interface
    * Patient height imports from csv **now convert from cm to m** - previously height was assumed to be cm and inserted
      into database without change. Existing height data will remain as cm value for csv imports, and m value for RDSR
      imports
    * Better handling of non-ASCII characters
    * Tube current is now extracted from Siemens Intevo RDSRs

* Exports

    * Patient sex is included in all exports
    * Filters generated by navigating through charts can now be used to filter export data
    * Study description and laterality are now included in mammography exports
    * Bi-fluoroscopy studies can be exported

* Skin dose maps

    * Fluoroscopy skin dose map data calculated to the surface of a simple geometric phantom
      using the in-built openSkin routines (3D phantom)
    * Phantom dimensions calculated from the height and mass of the patient
    * Data can be calculated on import to OpenREM, or on demand when a study is viewed
    * 3D skin dose map data shown graphically as a 2D image and a 3D model
    * If skin dose map display is disabled then fluoroscopy study data can be
      exported in a format suitable for the stand-alone openSkin routines

Updates since beta 7
====================
* Full screen charts
* Test implementation of QR SCU from the command line
* Equipment display names are now grouped by modality
* New docs and bug fixes

Updates since beta 9
====================
* QR SCU has been much improved
* Docs, charts and fixes: see git commits

Updates since beta 10
=====================
* QR SCU further improved with more testing
* QR SCU can now filter by include and exclude terms in study description
* QR SCU now safe with non-ASCII characters in series names etc
* Version number now only declared once in the project
* Monday is now the first day of the week in the pop-up date-pickers
* Improvements to chart tool-tip visibility
* 'Turn off charts' no longer changes the page
* Improvements (hopefully) to Store SCP - no longer a Celery task
* Improvements (hopefully) to task performance as long-running QR and export operations shouldn't queue tasks when there
  are unused workers
* Improvements (hopefully) to the keep-alive periodic task preventing requests stacking up when something goes wrong
* Improvements to docs, beginnings of DICOM networking docs

Updates since beta 11
=====================
* Fixed errors with DICOM store, keep_alive and echo functions

Updates since beta 12
=====================
* Mammography RDSRs now import correctly
* Added study description to mammography exports
* Philips Allura fluoro RDSRs import fixed
* Bi-plane fluoro exports fixed

Updates since beta 13
=====================
* Mammography RDSRs and images now record an Accumulated AGD per breast
* Mammography RDSRs and images now record mA in the same way as each other
* CTDIw phantom size now displayed in the detail view
* Patient size imports from CSV are now assumed to be cm and converted to m to store. Interface now assumes m
* Exposure time is now populated when not supplied for fluoro RDSRs
* DICOM Store and QR documentation updated, but not complete. Forms and text changed to demote OpenREM native DICOM
  Store and QR functionality

Updates since beta 14
=====================
* Senographe DS compression force now stored correctly in Newtons for new imports
* The display name of multiple systems can now be updated together using a single new name
* Non-ASCII characters can now be imported from TextValue fields in RDSR sequences
* Settings file has been updated
* Mammo laterality has been added to mammo exports
* Fixed in one of the beta versions was charts using greater than rather than greater than or equal to
* Fluoroscopy skin dose maps
* Display tables made neater

Updates since beta 15
=====================
* Normalised histogram tooltip now correctly reports frequency
* Tube current is now extracted from Siemens Intevo RDSRs

***************************************************
Upgrading an OpenREM server with no internet access
***************************************************

See the :doc:`upgrade-offline` docs.

..  _upgradefrom060:

****************************
Upgrading from version 0.6.0
****************************

* Back up your database

    * For PostgreSQL you can refer to :ref:`backup-psql-db`
    * For a non-production SQLite3 database, simply make a copy of the database file

* Stop any Celery workers

* The 0.7.0 upgrade must be made from a 0.6.0 (or later) database, and a schema migration is required:

.. sourcecode:: bash

    pip install openrem==0.7.0b15

In a shell/command window, move into the openrem folder:

* Ubuntu linux: ``/usr/local/lib/python2.7/dist-packages/openrem/``
* Other linux: ``/usr/lib/python2.7/site-packages/openrem/``
* Linux virtualenv: ``lib/python2.7/site-packages/openrem/``
* Windows: ``C:\Python27\Lib\site-packages\openrem\``
* Windows virtualenv: ``Lib\site-packages\openrem\``

Delete all numbered migration files in openrem's ``remapp/migrations`` folder, **leaving the 0002 files ending in .inactive**

If there is no file named ``__init__.py`` in the ``remapp/migrations`` folder, please create it.

.. sourcecode:: bash

    python manage.py migrate --fake-initial
    python manage.py makemigrations remapp
    python manage.py migrate remapp --fake

Now rename the file

.. sourcecode:: console

    remapp/migrations/0002_upgrade_0_7_from_0_6.py.inactive

to:

.. sourcecode:: console

    remapp/migrations/0002_upgrade_0_7_from_0_6.py

and then run

.. sourcecode:: console

    python manage.py migrate remapp

.. note::

    With a large database, this may take some time!

* Review the new ``local_settings.py.example`` file and copy accross the logging section. Then see
  :ref:`local_settings_logfile` settings in the install docs.

..  _upgradefrom070b:

********************************************
Upgrading from version 0.7.0 beta 7 or later
********************************************

* Stop any Celery workers

* You will need to do a database migration.

.. sourcecode:: bash

    pip install openrem==0.7.0b15

From the openrem folder (see above):

.. sourcecode:: bash

    python manage.py makemigrations remapp
    python manage.py migrate remapp

* Review the new ``local_settings.py.example`` file and copy accross the logging section. Then see
  :ref:`local_settings_logfile` settings in the install docs.


Restart all the services!
=========================

Some of the commands and services have changed - follow the guide at :doc:`startservices`.
