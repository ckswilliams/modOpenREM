########################################
OpenREM Release Notes version 0.7.0 beta
########################################

.. Warning::

    This is a beta version for developer testing. It is not suitable for general use, and the instructions below are
    likely to be incorrect.

****************
Headline changes
****************

* System

    * Django upgraded to version 1.8
    * Median function added to the database if using PostgreSQL
    * New user-defined display name for each unique system so that rooms with the same DICOM station name are displayed separately
    * Patient name and ID can optionally be stored in system, available for searching and export, but not displayed
    * Patient name, ID and accession number can be stored as a one-way hash, and remain searchable
    * Permission system has become more granular
    * System can now accept non-ASCII characters in protocol names etc
    * Menus have been tidied up

* Charts

    * Bar chart data points sorted by frequency, value or name in ascending or descending order
    * New chart of DLP per requested procedure type and requested procedure frequency
    * Chart data returned using AJAX to make pages more responsive
    * Chart plotting options available via Config menu

* DICOM Networking

    * Configuring and running DICOM Store SCP is now managed in the web interface
    * Query retrieve function is now built in to query PACS systems or modalities via the Import menu

* Exports

    * Patient sex is included in all exports
    * Filters generated by navigating through charts can now be used to filter export data

****************************
Upgrading from version 0.6.0
****************************

* Back up your database

    * For PostgreSQL you can refer to :doc:`backupRestorePostgreSQL`
    * For a non-production SQLite3 database, simply make a copy of the database file

* The 0.7.0 upgrade must be made from a 0.6.0 (or later) database, and a schema migration is required:

.. sourcecode:: bash

    pip install openrem==0.7.0b7

In a shell/command window, move into the openrem folder:

* Ubuntu linux: ``/usr/local/lib/python2.7/dist-packages/openrem/``
* Other linux: ``/usr/lib/python2.7/site-packages/openrem/``
* Linux virtualenv: ``lib/python2.7/site-packages/openrem/``
* Windows: ``C:\Python27\Lib\site-packages\openrem\``
* Windows virtualenv: ``Lib\site-packages\openrem``

Delete all numbered migration files in openrem's ``migrations`` folder.

If there is no file named ``__init__.py`` in the ``migrations`` folder, please create it. It should be empty. In Windows,
you might create a text file called ``__init__.txt``, then change the file suffix from ``.txt`` to ``.py``, and accept
the warning about files becoming unusable. In linux, ``touch remapp/migrations/__init__.py`` will do the job.

.. sourcecode:: bash

    python manage.py migrate --fake-initial
    python manage.py makemigrations remapp
    python manage.py migrate remapp --fake

* Now rename the file::

    0002_openrem_upgrade_add_new_tables_and_populate_and_add_median_function.py.inactive

  to::

    0002_openrem_upgrade_add_new_tables_and_populate_and_add_median_function.py

  and then run::

    python manage.py migrate remapp


Restart the web server
======================

If you are using the built-in test web server (`not for production use`)::

    python manage.py runserver x.x.x.x:8000 --insecure

Otherwise restart using the command for your web server

Restart the Celery task queue
=============================

For testing, in a new shell:

Linux::

    # Linux: Debian/Ubuntu and derivatives
    cd /usr/local/lib/python2.7/dist-packages/openrem/
    # Linux: other distros. In a virtualenv replace all up to lib/ as appropriate
    cd /usr/local/lib/python2.7/site-packages/openrem/

    celery multi start stores default -A openremproject -c:stores 2 -c 3 \
    -Q:stores stores -Q default \
    --pidfile=/path/to/media/celery/%N.pid --logfile=/path/to/media/celery/%N.log

If you intend to use OpenREM to provide a DICOM Store SCP (ie you can DICOM send things to OpenREM without using
any other program, such as Conquest), then we need a Celery Queue just for the store. The node (and queue) created for
this is called ``stores`` and it needs to have a concurrency equal or greater than the number of store SCPs. This would
normally be just one. So set ``-c:stores 1`` or ``-c:stores 2`` etc as you see fit. The ``-c 3`` specifies how many
workers should be available for all the other jobs - exports; and imports when using the OpenREM Store SCP.

You must also specify the location for the pid file and for the log file. You might put these in the media folder, or
the logs might go in ``/var/log/``.

The ``\`` is added in to allow the single command to go over several lines.

Windows::

    cd C:\Python27\Lib\site-packages\openrem\
    celery multi start stores default -A openremproject -c:stores 2 -c 3 ^
    -Q:stores stores -Q default ^
    --pidfile=\path\to\media\celery\%N.pid --logfile=\path\to\media\celery\%N.log

This is the same as for Linux, but this time the line continuation character is ``^``.

For production use, see http://celery.readthedocs.org/en/latest/tutorials/daemonizing.html

To stop the celery queues::

    celery multi stop stores default --pidfile=/path/to/media/celery/%N.pid


Celery periodic tasks: beat
===========================

Celery beat is a scheduler. If it is running, then every 60 seconds a task is run to check if any of the DICOM
Store SCP nodes are set to ``keep_alive``, and if they are, it tries to verify they are running with a DICOM echo.
If this is not successful, then the Store SCP is started.

To run celery beat, open a new shell:
Linux::

    cd /usr/local/lib/python2.7/dist-packages/openrem/

    celery -A openremproject beat -s /path/to/media/celery/celerybeat-schedule \
    -f /path/to/media/celery/celerybeat.log \
    --pidfile=/path/to/media/celery/celerybeat.pid

Windows::

    cd C:\Python27\Lib\site-packages\openrem\

    celery -A openremproject beat -s C:\path\to\media\celery\celerybeat-schedule ^
    -f C:\path\to\media\celery\celerybeat.log ^
    --pidfile=C:\path\to\media\celery\celerybeat.pid


Check the new settings
======================

* Go to ``Config -> Manage users`` and make sure the users have the right settings
    + ``viewgroup`` can browse the data only
    + ``importsizegroup`` can use the csv import facility to add patient height and weight information
    + ``importqrgroup`` can use the DICOM query-retrieve facility to pull in studies, as long as they are pre-configured
    + ``exportgroup`` can view and export data to a spreadsheet
    + ``pidgroup`` can search using patient names and IDs depending on settings, and export with patient names and IDs
      if they are also a member of the ``exportgroup``
    + ``admingroup`` can delete studies, configure DICOM Store/QR settings, configure DICOM keep or delete settings,
      configure patient ID settings, and abort and delete patient size import jobs. *Members of the admingroup no longer
      inherit the other groups permissions.*
* Return to the OpenREM interface (click on ``view site`` at the top right)
* Go to ``Config -> DICOM object delete settings`` and configure appropriately
* Go to ``Config -> Patient ID settings`` and configure appropriately
* If you want to use OpenREM as a DICOM store, or to use OpenREM to query remote systems, go to
  ``Config -> Dicom network configuration``. For more information go to :doc:`netdicom` (not yet up to date)
* Go to ``Config -> View and edit display names`` and review. If you have a lot of existing data you'll
  need to set a lot of display names, from each time the software version, station name, or other elements
  have changed. If you have upgraded from ``0.7.0b5``, edit each one in turn and save it.
