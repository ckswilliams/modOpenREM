CREATE FUNCTION _final_median(anyarray) RETURNS NUMERIC AS $$ 
  SELECT AVG(10000000000.0 * x)
  FROM
  (
    SELECT x,
           2 * ROW_NUMBER() OVER (ORDER BY x) - COUNT(*) OVER () AS y
    FROM UNNEST($1) x
  ) AS d
  WHERE y BETWEEN 0 AND 2;
$$ LANGUAGE SQL IMMUTABLE;

CREATE AGGREGATE median(anyelement) (
  SFUNC=array_append,
  STYPE=anyarray,
  FINALFUNC=_final_median,
  INITCOND='{}'
);